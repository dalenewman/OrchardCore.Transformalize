/*!
 * dragtable
 *
 * @Version 2.0.15
 *
 * Copyright (c) 2010-2013, Andres akottr@gmail.com
 * Dual licensed under the MIT (MIT-LICENSE.txt)
 * and GPL (GPL-LICENSE.txt) licenses.
 *
 * Inspired by the the dragtable from Dan Vanderkam (danvk.org/dragtable/)
 * Thanks to the jquery and jqueryui comitters
 *
 * Any comment, bug report, feature-request is welcome
 * Feel free to contact me.
 */
(function(n){function u(){var t=n('<style id="__dragtable_disable_text_selection__" type="text/css">body { -ms-user-select:none;-moz-user-select:-moz-none;-khtml-user-select:none;-webkit-user-select:none;user-select:none; }<\/style>');n(document.head).append(t);n(document.body).attr("onselectstart","return false;").attr("unselectable","on");window.getSelection?window.getSelection().removeAllRanges():document.selection.empty()}function f(){n("#__dragtable_disable_text_selection__").remove();t?n(document.body).attr("onselectstart",t):n(document.body).removeAttr("onselectstart");i?n(document.body).attr("unselectable",i):n(document.body).removeAttr("unselectable")}function r(n,t){var i=n.parentNode,r=n.nextSibling===t?n:n.nextSibling;t.parentNode.insertBefore(n,t);i.insertBefore(t,r)}n.widget("akottr.dragtable",{options:{revert:!1,dragHandle:".table-handle",maxMovingRows:40,excludeFooter:!1,onlyHeaderThreshold:100,dragaccept:null,persistState:null,restoreState:null,exact:!0,clickDelay:10,containment:null,cursor:"move",cursorAt:!1,distance:0,tolerance:"pointer",axis:"x",beforeStart:n.noop,beforeMoving:n.noop,beforeReorganize:n.noop,beforeStop:n.noop},originalTable:{el:null,selectedHandle:null,sortOrder:null,startIndex:0,endIndex:0},sortableTable:{el:n(),selectedHandle:n(),movingRow:n()},persistState:function(){var t=this;this.originalTable.el.find("th").each(function(n){this.id!==""&&(t.originalTable.sortOrder[this.id]=n)});n.ajax({url:this.options.persistState,data:this.originalTable.sortOrder})},_restoreState:function(t){for(var i in t)this.originalTable.startIndex=n("#"+i).closest("th").prevAll().length+1,this.originalTable.endIndex=parseInt(t[i],10)+1,this._bubbleCols()},_bubbleCols:function(){var n,t,u,f,e=this.originalTable.startIndex,o=this.originalTable.endIndex,i=this.originalTable.el.children();if(this.options.excludeFooter&&(i=i.not("tfoot")),e<o)for(n=e;n<o;n++)for(u=i.find("> tr > td:nth-child("+n+")").add(i.find("> tr > th:nth-child("+n+")")),f=i.find("> tr > td:nth-child("+(n+1)+")").add(i.find("> tr > th:nth-child("+(n+1)+")")),t=0;t<u.length;t++)r(u[t],f[t]);else for(n=e;n>o;n--)for(u=i.find("> tr > td:nth-child("+n+")").add(i.find("> tr > th:nth-child("+n+")")),f=i.find("> tr > td:nth-child("+(n-1)+")").add(i.find("> tr > th:nth-child("+(n-1)+")")),t=0;t<u.length;t++)r(u[t],f[t])},_rearrangeTableBackroundProcessing:function(){var t=this;return function(){t._bubbleCols();t.options.beforeStop(t.originalTable);t.sortableTable.el.remove();f();t.options.persistState!==null&&(n.isFunction(t.options.persistState)?t.options.persistState(t.originalTable):t.persistState())}},_rearrangeTable:function(){var n=this;return function(){n.originalTable.selectedHandle.removeClass("dragtable-handle-selected");n.sortableTable.el.sortable("disable");n.sortableTable.el.addClass("dragtable-disabled");n.options.beforeReorganize(n.originalTable,n.sortableTable);n.originalTable.endIndex=n.sortableTable.movingRow.prevAll().length+1;setTimeout(n._rearrangeTableBackroundProcessing(),50)}},_generateSortable:function(t){var r,c,l,y,i,p,h;t.cancelBubble||(t.cancelBubble=!0);var o=this,f=this.originalTable.el[0].attributes,v="";for(r=0;r<f.length;r++)f[r].nodeValue&&f[r].nodeName!="id"&&f[r].nodeName!="width"&&(v+=f[r].nodeName+'="'+f[r].nodeValue+'" ');c=[];l=[];this.originalTable.el.find("tr").slice(0,this.options.maxMovingRows).each(function(){for(var i=this.attributes,r="",t=0;t<i.length;t++)i[t].nodeValue&&i[t].nodeName!="id"&&(r+=" "+i[t].nodeName+'="'+i[t].nodeValue+'"');c.push(r);l.push(n(this).height())});var a=[],s=0,e=o.originalTable.el.children();this.options.excludeFooter&&(e=e.not("tfoot"));e.find("> tr > th").each(function(){var t=n(this).is(":visible")?n(this).outerWidth():0;a.push(t);s+=t});o.options.exact&&(y=s-o.originalTable.el.outerWidth(),a[0]-=y);s+=2;i='<ul class="dragtable-sortable" style="position:absolute; width:'+s+'px;">';e.find("> tr > th").each(function(t){var u=n(this).is(":visible")?n(this).outerWidth():0,r;i+='<li style="width:'+u+'px;">';i+="<table "+v+">";r=e.find("> tr > th:nth-child("+(t+1)+")");o.options.maxMovingRows>1&&(r=r.add(e.find("> tr > td:nth-child("+(t+1)+")").slice(0,o.options.maxMovingRows-1)));r.each(function(t){var r=n(this).clone().wrap("<div><\/div>").parent().html();r.toLowerCase().indexOf("<th")===0&&(i+="<thead>");i+="<tr "+c[t]+'" style="height:'+l[t]+'px;">';i+=r;r.toLowerCase().indexOf("<th")===0&&(i+="<\/thead>");i+="<\/tr>"});i+="<\/table>";i+="<\/li>"});i+="<\/ul>";this.sortableTable.el=this.originalTable.el.before(i).prev();this.sortableTable.el.find("> li > table").each(function(t){n(this).css("width",a[t]+"px")});this.sortableTable.selectedHandle=this.sortableTable.el.find("th .dragtable-handle-selected");p=this.options.dragaccept?"li:has("+this.options.dragaccept+")":"li";this.sortableTable.el.sortable({items:p,stop:this._rearrangeTable(),revert:this.options.revert,tolerance:this.options.tolerance,containment:this.options.containment,cursor:this.options.cursor,cursorAt:this.options.cursorAt,distance:this.options.distance,axis:this.options.axis});this.originalTable.startIndex=n(t.target).closest("th").prevAll().length+1;this.options.beforeMoving(this.originalTable,this.sortableTable);this.sortableTable.movingRow=this.sortableTable.el.find("> li:nth-child("+this.originalTable.startIndex+")");u();this.sortableTable.movingRow.trigger(n.extend(n.Event(t.type),{which:1,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,screenX:t.screenX,screenY:t.screenY}));h=this.sortableTable.el.find(".ui-sortable-placeholder");!h.height()<=0&&h.css("height",this.sortableTable.el.find(".ui-sortable-helper").height());h.html('<div class="outer" style="height:100%;"><div class="inner" style="height:100%;"><\/div><\/div>')},bindTo:{},_create:function(){this.originalTable={el:this.element,selectedHandle:n(),sortOrder:{},startIndex:0,endIndex:0};this.bindTo=this.originalTable.el.find("th");this.options.dragaccept&&(this.bindTo=this.bindTo.filter(this.options.dragaccept));this.bindTo.find(this.options.dragHandle).length>0&&(this.bindTo=this.bindTo.find(this.options.dragHandle));this.options.restoreState!==null&&(n.isFunction(this.options.restoreState)?this.options.restoreState(this.originalTable):this._restoreState(this.options.restoreState));var t=this;this.bindTo.mousedown(function(i){i.which===1&&t.options.beforeStart(t.originalTable)!==!1&&(clearTimeout(this.downTimer),this.downTimer=setTimeout(function(){t.originalTable.selectedHandle=n(this);t.originalTable.selectedHandle.addClass("dragtable-handle-selected");t._generateSortable(i)},t.options.clickDelay))}).mouseup(function(){clearTimeout(this.downTimer)})},redraw:function(){this.destroy();this._create()},destroy:function(){this.bindTo.unbind("mousedown");n.Widget.prototype.destroy.apply(this,arguments)}});var t=n(document.body).attr("onselectstart"),i=n(document.body).attr("unselectable")})(jQuery);