(function(n){typeof exports=="object"&&typeof module=="object"?n(require("../../lib/codemirror"),require("./searchcursor"),require("../scroll/annotatescrollbar")):typeof define=="function"&&define.amd?define(["../../lib/codemirror","./searchcursor","../scroll/annotatescrollbar"],n):n(CodeMirror)})(function(n){"use strict";function t(n,t,i,r){var u,f,e;this.cm=n;this.options=r;u={listenForChanges:!1};for(f in r)u[f]=r[f];u.className||(u.className="CodeMirror-search-match");this.annotation=n.annotateScrollbar(u);this.query=t;this.caseFold=i;this.gap={from:n.firstLine(),to:n.lastLine()+1};this.matches=[];this.update=null;this.findMatches();this.annotation.update(this.matches);e=this;n.on("change",this.changeHandler=function(n,t){e.onChange(t)})}function i(n,t,i){return n<=t?n:Math.max(t,n+i)}n.defineExtension("showMatchesOnScrollbar",function(n,i,r){return typeof r=="string"&&(r={className:r}),r||(r={}),new t(this,n,i,r)});var r=1e3;t.prototype.findMatches=function(){var t,u,f,i;if(this.gap){for(t=0;t<this.matches.length;t++){if(i=this.matches[t],i.from.line>=this.gap.to)break;i.to.line>=this.gap.from&&this.matches.splice(t--,1)}for(u=this.cm.getSearchCursor(this.query,n.Pos(this.gap.from,0),{caseFold:this.caseFold,multiline:this.options.multiline}),f=this.options&&this.options.maxMatches||r;u.findNext();){if(i={from:u.from(),to:u.to()},i.from.line>=this.gap.to)break;if(this.matches.splice(t++,0,i),this.matches.length>f)break}this.gap=null}};t.prototype.onChange=function(t){var f=t.from.line,h=n.changeEnd(t).line,u=h-t.to.line,e,r,o,s,c;if(this.gap?(this.gap.from=Math.min(i(this.gap.from,f,u),t.from.line),this.gap.to=Math.max(i(this.gap.to,f,u),t.from.line)):this.gap={from:t.from.line,to:h+1},u)for(e=0;e<this.matches.length;e++)r=this.matches[e],o=i(r.from.line,f,u),o!=r.from.line&&(r.from=n.Pos(o,r.from.ch)),s=i(r.to.line,f,u),s!=r.to.line&&(r.to=n.Pos(s,r.to.ch));clearTimeout(this.update);c=this;this.update=setTimeout(function(){c.updateAfterChange()},250)};t.prototype.updateAfterChange=function(){this.findMatches();this.annotation.update(this.matches)};t.prototype.clear=function(){this.cm.off("change",this.changeHandler);this.annotation.clear()}});