(function(n){typeof exports=="object"&&typeof module=="object"?n(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):typeof define=="function"&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],n):n(CodeMirror)})(function(n){"use strict";function y(n,t){return typeof n=="string"?n=new RegExp(n.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),t?"gi":"g"):n.global||(n=new RegExp(n.source,n.ignoreCase?"gi":"g")),{token:function(t){n.lastIndex=t.pos;var i=n.exec(t.string);if(i&&i.index==t.pos)return t.pos+=i[0].length||1,"searching";i?t.pos=i.index:t.skipToEnd()}}}function p(){this.posFrom=this.posTo=this.lastQuery=this.query=null;this.overlay=null}function i(n){return n.state.search||(n.state.search=new p)}function f(n){return typeof n=="string"&&n==n.toLowerCase()}function r(n,t,i){return n.getSearchCursor(t,i,{caseFold:f(t),multiline:!0})}function w(n,t,i,r,f){n.openDialog(t,r,{value:i,selectValueOnOpen:!0,closeOnEnter:!1,onClose:function(){u(n)},onKeyDown:f})}function s(n,t,i,r,u){n.openDialog?n.openDialog(t,u,{value:r,selectValueOnOpen:!0}):u(prompt(i,r))}function b(n,t,i,r){n.openConfirm?n.openConfirm(t,r):confirm(i)&&r[0]()}function h(n){return n.replace(/\\([nrt\\])/g,function(n,t){return t=="n"?"\n":t=="r"?"\r":t=="t"?"\t":t=="\\"?"\\":n})}function c(n){var t=n.match(/^\/(.*)\/([a-z]*)$/);if(t)try{n=new RegExp(t[1],t[2].indexOf("i")==-1?"":"i")}catch(i){}else n=h(n);return(typeof n=="string"?n=="":n.test(""))&&(n=/x^/),n}function e(n,t,i){t.queryText=i;t.query=c(i);n.removeOverlay(t.overlay,f(t.query));t.overlay=y(t.query,f(t.query));n.addOverlay(t.overlay);n.showMatchesOnScrollbar&&(t.annotate&&(t.annotate.clear(),t.annotate=null),t.annotate=n.showMatchesOnScrollbar(t.query,f(t.query)))}function t(t,r,u,f){var h=i(t),c,a,v;if(h.query)return o(t,r);c=t.getSelection()||h.lastQuery;c instanceof RegExp&&c.source=="x^"&&(c=null);u&&t.openDialog?(a=null,v=function(i,r){(n.e_stop(r),i)&&(i!=h.queryText&&(e(t,h,i),h.posFrom=h.posTo=t.getCursor()),a&&(a.style.opacity=1),o(t,r.shiftKey,function(n,i){var r;i.line<3&&document.querySelector&&(r=t.display.wrapper.querySelector(".CodeMirror-dialog"))&&r.getBoundingClientRect().bottom-4>t.cursorCoords(i,"window").top&&((a=r).style.opacity=.4)}))},w(t,l(t),c,v,function(r,u){var o=n.keyName(r),s=t.getOption("extraKeys"),f=s&&s[o]||n.keyMap[t.getOption("keyMap")][o];f=="findNext"||f=="findPrev"||f=="findPersistentNext"||f=="findPersistentPrev"?(n.e_stop(r),e(t,i(t),u),t.execCommand(f)):(f=="find"||f=="findPersistent")&&(n.e_stop(r),v(u,r))}),f&&c&&(e(t,h,c),o(t,r))):s(t,l(t),"Search for:",c,function(n){n&&!h.query&&t.operation(function(){e(t,h,n);h.posFrom=h.posTo=t.getCursor();o(t,r)})})}function o(t,u,f){t.operation(function(){var o=i(t),e=r(t,o.query,u?o.posFrom:o.posTo);(e.find(u)||(e=r(t,o.query,u?n.Pos(t.lastLine()):n.Pos(t.firstLine(),0)),e.find(u)))&&(t.setSelection(e.from(),e.to()),t.scrollIntoView({from:e.from(),to:e.to()},20),o.posFrom=e.from(),o.posTo=e.to(),f&&f(e.from(),e.to()))})}function u(n){n.operation(function(){var t=i(n);(t.lastQuery=t.query,t.query)&&(t.query=t.queryText=null,n.removeOverlay(t.overlay),t.annotate&&(t.annotate.clear(),t.annotate=null))})}function l(n){return'<span class="CodeMirror-search-label">'+n.phrase("Search:")+'<\/span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">'+n.phrase("(Use /re/ syntax for regexp search)")+"<\/span>"}function k(n){return' <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">'+n.phrase("(Use /re/ syntax for regexp search)")+"<\/span>"}function d(n){return'<span class="CodeMirror-search-label">'+n.phrase("With:")+'<\/span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/>'}function g(n){return'<span class="CodeMirror-search-label">'+n.phrase("Replace?")+"<\/span> <button>"+n.phrase("Yes")+"<\/button> <button>"+n.phrase("No")+"<\/button> <button>"+n.phrase("All")+"<\/button> <button>"+n.phrase("Stop")+"<\/button> "}function a(n,t,i){n.operation(function(){for(var f,u=r(n,t);u.findNext();)typeof t!="string"?(f=n.getRange(u.from(),u.to()).match(t),u.replace(i.replace(/\$(\d)/g,function(n,t){return f[t]}))):u.replace(i)})}function v(n,t){if(!n.getOption("readOnly")){var e=n.getSelection()||i(n).lastQuery,f='<span class="CodeMirror-search-label">'+(t?n.phrase("Replace all:"):n.phrase("Replace:"))+"<\/span>";s(n,f+k(n),f,e,function(i){i&&(i=c(i),s(n,d(n),n.phrase("Replace with:"),"",function(f){if(f=h(f),t)a(n,i,f);else{u(n);var e=r(n,i,n.getCursor("from")),o=function(){var t=e.from(),u;((u=e.findNext())||(e=r(n,i),(u=e.findNext())&&(!t||e.from().line!=t.line||e.from().ch!=t.ch)))&&(n.setSelection(e.from(),e.to()),n.scrollIntoView({from:e.from(),to:e.to()}),b(n,g(n),n.phrase("Replace?"),[function(){s(u)},o,function(){a(n,i,f)}]))},s=function(n){e.replace(typeof i=="string"?f:f.replace(/\$(\d)/g,function(t,i){return n[i]}));o()};o()}}))})}}n.commands.find=function(n){u(n);t(n)};n.commands.findPersistent=function(n){u(n);t(n,!1,!0)};n.commands.findPersistentNext=function(n){t(n,!1,!0,!0)};n.commands.findPersistentPrev=function(n){t(n,!0,!0,!0)};n.commands.findNext=t;n.commands.findPrev=function(n){t(n,!0)};n.commands.clearSearch=u;n.commands.replace=v;n.commands.replaceAll=function(n){v(n,!0)}});