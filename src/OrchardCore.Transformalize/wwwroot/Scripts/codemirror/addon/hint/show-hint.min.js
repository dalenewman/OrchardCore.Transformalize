(function(n){typeof exports=="object"&&typeof module=="object"?n(require("../../lib/codemirror")):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";function r(n,t){this.cm=n;this.options=t;this.widget=null;this.debounce=0;this.tick=0;this.startPos=this.cm.getCursor("start");this.startLen=this.cm.getLine(this.startPos.line).length-this.cm.getSelection().length;var i=this;n.on("cursorActivity",this.activityFunc=function(){i.cursorActivity()})}function l(n,t,r){var e=n.options.hintOptions,f={};for(var u in i)f[u]=i[u];if(e)for(u in e)e[u]!==undefined&&(f[u]=e[u]);if(r)for(u in r)r[u]!==undefined&&(f[u]=r[u]);return f.hint.resolve&&(f.hint=f.hint.resolve(n,t)),f}function e(n){return typeof n=="string"?n:n.text}function a(n,t){function o(n,i){var r;r=typeof i!="string"?function(n){return i(n,t)}:u.hasOwnProperty(i)?u[i]:i;e[n]=r}var u={Up:function(){t.moveFocus(-1)},Down:function(){t.moveFocus(1)},PageUp:function(){t.moveFocus(-t.menuSize()+1,!0)},PageDown:function(){t.moveFocus(t.menuSize()-1,!0)},Home:function(){t.setFocus(0)},End:function(){t.setFocus(t.length-1)},Enter:t.pick,Tab:t.pick,Esc:t.close},s=/Mac/.test(navigator.platform),r,e,f,i;if(s&&(u["Ctrl-P"]=function(){t.moveFocus(-1)},u["Ctrl-N"]=function(){t.moveFocus(1)}),r=n.options.customKeys,e=r?{}:u,r)for(i in r)r.hasOwnProperty(i)&&o(i,r[i]);if(f=n.options.extraKeys,f)for(i in f)f.hasOwnProperty(i)&&o(i,f[i]);return e}function o(n,t){while(t&&t!=n){if(t.nodeName.toUpperCase()==="LI"&&t.parentNode==n)return t;t=t.parentNode}}function s(i,r){var w,p,k,ft,et,pt,ct,ot,d,wt;this.completion=i;this.data=r;this.picked=!1;var l=this,s=i.cm,f=s.getInputField().ownerDocument,g=f.defaultView||f.parentWindow,u=this.hints=f.createElement("ul"),bt=i.cm.options.theme;for(u.className="CodeMirror-hints "+bt,this.selectedHint=r.selectedHint||0,w=r.list,p=0;p<w.length;++p){var nt=u.appendChild(f.createElement("li")),y=w[p],st=c+(p!=this.selectedHint?"":" "+t);y.className!=null&&(st=y.className+" "+st);nt.className=st;y.render?y.render(nt,r,y):nt.appendChild(f.createTextNode(y.displayText||e(y)));nt.hintId=p}var b=i.options.container||f.body,v=s.cursorCoords(i.options.alignWithWord?r.from:null),tt=v.left,it=v.bottom,lt=!0,rt=0,ut=0;if(b!==f.body){var kt=["absolute","relative","fixed"].indexOf(g.getComputedStyle(b).position)!==-1,ht=kt?b:b.offsetParent,at=ht.getBoundingClientRect(),vt=f.body.getBoundingClientRect();rt=at.left-vt.left-ht.scrollLeft;ut=at.top-vt.top-ht.scrollTop}u.style.left=tt-rt+"px";u.style.top=it-ut+"px";k=g.innerWidth||Math.max(f.body.offsetWidth,f.documentElement.offsetWidth);ft=g.innerHeight||Math.max(f.body.offsetHeight,f.documentElement.offsetHeight);b.appendChild(u);var h=u.getBoundingClientRect(),dt=h.bottom-ft,gt=u.scrollHeight>u.clientHeight+1,yt=s.getScrollInfo();if(dt>0&&(et=h.bottom-h.top,pt=v.top-(v.bottom-h.top),pt-et>0?(u.style.top=(it=v.top-et-ut)+"px",lt=!1):et>ft&&(u.style.height=ft-5+"px",u.style.top=(it=v.bottom-h.top-ut)+"px",ct=s.getCursor(),r.from.ch!=ct.ch&&(v=s.cursorCoords(ct),u.style.left=(tt=v.left-rt)+"px",h=u.getBoundingClientRect()))),ot=h.right-k,ot>0&&(h.right-h.left>k&&(u.style.width=k-5+"px",ot-=h.right-h.left-k),u.style.left=(tt=v.left-ot-rt)+"px"),gt)for(d=u.firstChild;d;d=d.nextSibling)d.style.paddingRight=s.display.nativeBarWidth+"px";if(s.addKeyMap(this.keyMap=a(i,{moveFocus:function(n,t){l.changeActive(l.selectedHint+n,t)},setFocus:function(n){l.changeActive(n)},menuSize:function(){return l.screenAmount()},length:w.length,close:function(){i.close()},pick:function(){l.pick()},data:r})),i.options.closeOnUnfocus){s.on("blur",this.onBlur=function(){wt=setTimeout(function(){i.close()},100)});s.on("focus",this.onFocus=function(){clearTimeout(wt)})}s.on("scroll",this.onScroll=function(){var t=s.getScrollInfo(),r=s.getWrapperElement().getBoundingClientRect(),e=it+yt.top-t.top,n=e-(g.pageYOffset||(f.documentElement||f.body).scrollTop);if(lt||(n+=u.offsetHeight),n<=r.top||n>=r.bottom)return i.close();u.style.top=e+"px";u.style.left=tt+yt.left-t.left+"px"});n.on(u,"dblclick",function(n){var t=o(u,n.target||n.srcElement);t&&t.hintId!=null&&(l.changeActive(t.hintId),l.pick())});n.on(u,"click",function(n){var t=o(u,n.target||n.srcElement);t&&t.hintId!=null&&(l.changeActive(t.hintId),i.options.completeOnSingleClick&&l.pick())});n.on(u,"mousedown",function(){setTimeout(function(){s.focus()},20)});return this.scrollToActive(),n.signal(r,"select",w[this.selectedHint],u.childNodes[this.selectedHint]),!0}function v(n,t){var r,i;if(!n.somethingSelected())return t;for(r=[],i=0;i<t.length;i++)t[i].supportsSelection&&r.push(t[i]);return r}function h(n,t,i,r){if(n.async)n(t,r,i);else{var u=n(t,i);u&&u.then?u.then(r):r(u)}}function y(t,i){var u=t.getHelpers(i,"hint"),f,r;return u.length?(r=function(n,t,i){function f(u){if(u==r.length)return t(null);h(r[u],n,i,function(n){n&&n.list.length>0?t(n):f(u+1)})}var r=v(n,u);f(0)},r.async=!0,r.supportsSelection=!0,r):(f=t.getHelper(t.getCursor(),"hintWords"))?function(t){return n.hint.fromList(t,{words:f})}:n.hint.anyword?function(t,i){return n.hint.anyword(t,i)}:function(){}}var c="CodeMirror-hint",t="CodeMirror-hint-active",u,f,i;n.showHint=function(n,t,i){var r,u;if(!t)return n.showHint(i);if(i&&i.async&&(t.async=!0),r={hint:t},i)for(u in i)r[u]=i[u];return n.showHint(r)};n.defineExtension("showHint",function(t){var i,u,f;if(t=l(this,this.getCursor("start"),t),i=this.listSelections(),!(i.length>1)){if(this.somethingSelected()){if(!t.hint.supportsSelection)return;for(u=0;u<i.length;u++)if(i[u].head.line!=i[u].anchor.line)return}(this.state.completionActive&&this.state.completionActive.close(),f=this.state.completionActive=new r(this,t),f.options.hint)&&(n.signal(this,"startCompletion",this),f.update(!0))}});n.defineExtension("closeHint",function(){this.state.completionActive&&this.state.completionActive.close()});u=window.requestAnimationFrame||function(n){return setTimeout(n,1e3/60)};f=window.cancelAnimationFrame||clearTimeout;r.prototype={close:function(){this.active()&&(this.cm.state.completionActive=null,this.tick=null,this.cm.off("cursorActivity",this.activityFunc),this.widget&&this.data&&n.signal(this.data,"close"),this.widget&&this.widget.close(),n.signal(this.cm,"endCompletion",this.cm))},active:function(){return this.cm.state.completionActive==this},pick:function(t,i){var r=t.list[i];r.hint?r.hint(this.cm,t,r):this.cm.replaceRange(e(r),r.from||t.from,r.to||t.to,"complete");n.signal(t,"pick",r);this.close()},cursorActivity:function(){var n,t,i;this.debounce&&(f(this.debounce),this.debounce=0);n=this.cm.getCursor();t=this.cm.getLine(n.line);n.line!=this.startPos.line||t.length-n.ch!=this.startLen-this.startPos.ch||n.ch<this.startPos.ch||this.cm.somethingSelected()||!n.ch||this.options.closeCharacters.test(t.charAt(n.ch-1))?this.close():(i=this,this.debounce=u(function(){i.update()}),this.widget&&this.widget.disable())},update:function(n){if(this.tick!=null){var t=this,i=++this.tick;h(this.options.hint,this.cm,this.options,function(r){t.tick==i&&t.finishUpdate(r,n)})}},finishUpdate:function(t,i){this.data&&n.signal(this.data,"update");var r=this.widget&&this.widget.picked||i&&this.options.completeSingle;this.widget&&this.widget.close();this.data=t;t&&t.list.length&&(r&&t.list.length==1?this.pick(t,0):(this.widget=new s(this,t),n.signal(t,"shown")))}};s.prototype={close:function(){if(this.completion.widget==this){this.completion.widget=null;this.hints.parentNode.removeChild(this.hints);this.completion.cm.removeKeyMap(this.keyMap);var n=this.completion.cm;this.completion.options.closeOnUnfocus&&(n.off("blur",this.onBlur),n.off("focus",this.onFocus));n.off("scroll",this.onScroll)}},disable:function(){this.completion.cm.removeKeyMap(this.keyMap);var n=this;this.keyMap={Enter:function(){n.picked=!0}};this.completion.cm.addKeyMap(this.keyMap)},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(i,r){if(i>=this.data.list.length?i=r?this.data.list.length-1:0:i<0&&(i=r?0:this.data.list.length-1),this.selectedHint!=i){var u=this.hints.childNodes[this.selectedHint];u&&(u.className=u.className.replace(" "+t,""));u=this.hints.childNodes[this.selectedHint=i];u.className+=" "+t;this.scrollToActive();n.signal(this.data,"select",this.data.list[this.selectedHint],u)}},scrollToActive:function(){var n=this.hints.childNodes[this.selectedHint];n.offsetTop<this.hints.scrollTop?this.hints.scrollTop=n.offsetTop-3:n.offsetTop+n.offsetHeight>this.hints.scrollTop+this.hints.clientHeight&&(this.hints.scrollTop=n.offsetTop+n.offsetHeight-this.hints.clientHeight+3)},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1}};n.registerHelper("hint","auto",{resolve:y});n.registerHelper("hint","fromList",function(t,i){var r=t.getCursor(),u=t.getTokenAt(r),f,h=n.Pos(r.line,u.start),c=r,e,o,s;for(u.start<r.ch&&/\w/.test(u.string.charAt(r.ch-u.start-1))?f=u.string.substr(0,r.ch-u.start):(f="",h=r),e=[],o=0;o<i.words.length;o++)s=i.words[o],s.slice(0,f.length)==f&&e.push(s);if(e.length)return{list:e,from:h,to:c}});n.commands.autocomplete=n.showHint;i={hint:n.hint.auto,completeSingle:!0,alignWithWord:!0,closeCharacters:/[\s()\[\]{};:>,]/,closeOnUnfocus:!0,completeOnSingleClick:!0,container:null,customKeys:null,extraKeys:null};n.defineOption("hintOptions",null)});