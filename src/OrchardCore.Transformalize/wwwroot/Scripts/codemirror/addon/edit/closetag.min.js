(function(n){typeof exports=="object"&&typeof module=="object"?n(require("../../lib/codemirror"),require("../fold/xml-fold")):typeof define=="function"&&define.amd?define(["../../lib/codemirror","../fold/xml-fold"],n):n(CodeMirror)})(function(n){function e(i){var b,k,y,rt,e,l,d;if(i.getOption("disableInput"))return n.Pass;var a=i.listSelections(),p=[],c=i.getOption("autoCloseTags");for(e=0;e<a.length;e++){if(!a[e].empty())return n.Pass;var o=a[e].head,s=i.getTokenAt(o),v=n.innerMode(i.getMode(),s.state),g=v.state,w=v.mode.xmlCurrentTag&&v.mode.xmlCurrentTag(g),h=w&&w.name;if(!h)return n.Pass;var nt=v.mode.configuration=="html",tt=typeof c=="object"&&c.dontCloseTags||nt&&u,it=typeof c=="object"&&c.indentTags||nt&&f;if(s.end>o.ch&&(h=h.slice(0,h.length-s.end+o.ch)),b=h.toLowerCase(),!h||s.type=="string"&&(s.end!=o.ch||!/[\"\']/.test(s.string.charAt(s.string.length-1))||s.string.length==1)||s.type=="tag"&&w.close||s.string.indexOf("/")==o.ch-s.start-1||tt&&t(tt,b)>-1||r(i,v.mode.xmlCurrentContext&&v.mode.xmlCurrentContext(g)||[],h,o,!0))return n.Pass;if(k=typeof c=="object"&&c.emptyTags,k&&t(k,h)>-1){p[e]={text:"/>",newPos:n.Pos(o.line,o.ch+2)};continue}y=it&&t(it,b)>-1;p[e]={indent:y,text:">"+(y?"\n\n":"")+"<\/"+h+">",newPos:y?n.Pos(o.line+1,0):n.Pos(o.line,o.ch+1)}}for(rt=typeof c=="object"&&c.dontIndentOnAutoClose,e=a.length-1;e>=0;e--)l=p[e],i.replaceRange(l.text,a[e].head,a[e].anchor,"+insert"),d=i.listSelections().slice(0),d[e]={head:l.newPos,anchor:l.newPos},i.setSelections(d),!rt&&l.indent&&(i.indentLine(l.newPos.line,null,!0),i.indentLine(l.newPos.line+1,null,!0))}function i(t,i){for(var h,a,e,f=t.listSelections(),v=[],l=i?"/":"<\/",y=t.getOption("autoCloseTags"),p=typeof y=="object"&&y.dontIndentOnSlash,u=0;u<f.length;u++){if(!f[u].empty())return n.Pass;var c=f[u].head,s=t.getTokenAt(c),o=n.innerMode(t.getMode(),s.state),w=o.state;if(i&&(s.type=="string"||s.string.charAt(0)!="<"||s.start!=c.ch-1))return n.Pass;if(a=o.mode.name!="xml"&&t.getMode().name=="htmlmixed",a&&o.mode.name=="javascript")h=l+"script";else if(a&&o.mode.name=="css")h=l+"style";else{if(e=o.mode.xmlCurrentContext&&o.mode.xmlCurrentContext(w),!e||e.length&&r(t,e,e[e.length-1],c))return n.Pass;h=l+e[e.length-1]}t.getLine(c.line).charAt(s.end)!=">"&&(h+=">");v[u]=h}if(t.replaceSelections(v),f=t.listSelections(),!p)for(u=0;u<f.length;u++)(u==f.length-1||f[u].head.line<f[u+1].head.line)&&t.indentLine(f[u].head.line)}function o(t){return t.getOption("disableInput")?n.Pass:i(t,!0)}function t(n,t){if(n.indexOf)return n.indexOf(t);for(var i=0,r=n.length;i<r;++i)if(n[i]==t)return i;return-1}function r(t,i,r,u,f){var h,o,c,e,s;if(!n.scanForClosingTag||(h=Math.min(t.lastLine()+1,u.line+500),o=n.scanForClosingTag(t,u,null,h),!o||o.tag!=r))return!1;for(c=f?1:0,e=i.length-1;e>=0;e--)if(i[e]==r)++c;else break;for(u=o.to,e=1;e<c;e++){if(s=n.scanForClosingTag(t,u,null,h),!s||s.tag!=r)return!1;u=s.to}return!0}n.defineOption("autoCloseTags",!1,function(t,i,r){if(r!=n.Init&&r&&t.removeKeyMap("autoCloseTags"),i){var u={name:"autoCloseTags"};(typeof i!="object"||i.whenClosing)&&(u["'/'"]=function(n){return o(n)});(typeof i!="object"||i.whenOpening)&&(u["'>'"]=function(n){return e(n)});t.addKeyMap(u)}});var u=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"],f=["applet","blockquote","body","button","div","dl","fieldset","form","frameset","h1","h2","h3","h4","h5","h6","head","html","iframe","layer","legend","object","ol","p","select","table","ul"];n.commands.closeTag=function(n){return i(n)}});